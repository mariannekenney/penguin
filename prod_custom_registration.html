<!DOCTYPE html>
<html lang="en">

<body>
  <script>
    let registrationType, registrationInfo;

    class RegistrationType {
      constructor() {
      }

      execute() {
        // Remove options based on membership / pricing
        const labels = Array.from(document.querySelectorAll('strong.labelTitle.paymentTitle label'))
          .map(element => element.textContent.trim());

        const groups = {};

        labels.forEach(label => {
          const split = label.split(" ");
          if (split.length > 2){
            const key = `${split[0]} ${split[1]}`;

            if (groups[key]) {
              const newSplit = Number(label.split('$')[1]?.split('.')[0]);
              const existingSplit = Number(groups[key].split('$')[1]?.split('.')[0]);

              if (newSplit < existingSplit) {
                groups[key] = label;
              }
            } else {
              groups[key] = label;
            }
          }
        });

        const duplicates = labels.filter(label => label.includes('$') && !Object.values(groups).includes(label));

        if (duplicates.length > 0) {
          document.querySelectorAll('.eventRegistrationTypeRadioWrapper').forEach(item => {
            const label = item.querySelector('label').textContent.trim();

            if (duplicates.includes(label)) {
              item.style.display = 'none';
            }
          })
        }
      }
    }

    class RegistrationInfo {
      constructor(isEarly, isMember, eventId, eventLimits, registrationData) {
        this.isEarly = isEarly;
        this.isMember = isMember;
        this.eventId = eventId;
        this.eventLimits = eventLimits;
        this.registrationData = registrationData;
        this.emailRecipientIds = [27905286, 54159054, 27905257];
      }

      execute() {
        this.limitOptions();
        this.limitWithSubOptions();
        this.becomeMember();
        this.rainInsurance();
        this.cancellationTerms();
      }

      limitOptions() {
        const waitlistedFields = ['Class Attending'];
        const soldOutFields = [];
        const soldOutNames = [];

        const eventData = this.eventLimits.filter(item => !item.suboption).map(item => {
          item.limit = parseInt(item.limit);

          item.count = this.registrationData
            .map(data =>
              data.RegistrationFields.find(field => field.FieldName.includes(item.name))
            )
            .filter(data => {
              const label = Array.isArray(data.Value) ? data.Value[0]?.Label : data.Value?.Label;
              return label?.includes(item.option);
            }).length;

          return item;
        });

        eventData
          .filter(data => data.limit && data.count >= data.limit)
          .forEach(data => {
            const field = Array.from(document.querySelectorAll('div[class*="fieldContainer"]'))
              .filter(container =>
                container.querySelector('span[id*="titleLabel"]')?.textContent.includes(data.name)
              )[0];

            field.querySelectorAll('div[class*="fieldItem"]')
              .forEach(item => {
                const label = item.querySelector('label');

                if (label.textContent.includes(data.option)) {
                  label.innerHTML = `<span style="text-decoration: line-through">${label.textContent}</span>`;
                  item.querySelector('input').disabled = true;
                }
              });

            if (waitlistedFields.includes(data.name)) {
              if (!soldOutFields.includes(field)) soldOutFields.push(field);

              const index = waitlistedFields.indexOf(data.name);
              if (soldOutNames[index]) {
                soldOutNames[index].push(data.option);
              } else {
                soldOutNames.push([data.option]);
              }
            }
          });

        waitlistedFields.forEach((_, i) => {
          if (soldOutFields.length > 0) {
            this.addWaitlist(soldOutFields[i], soldOutNames[i]);
          }
        });
      }

      limitWithSubOptions() {
        const eventData = this.eventLimits.filter(item => item.suboption).map(item => {
          item.limit = parseInt(item.limit);

          const itemName = item.name.split(" & ");
          item.count = this.registrationData
            .map(data =>
              ({
                main: data.RegistrationFields.find(field => field.FieldName.includes(itemName[0])),
                sub: data.RegistrationFields.find(field => field.FieldName.includes(itemName[1]))
              })
            )
            .filter(data => {
              const mainLabel = Array.isArray(data.main.Value) ? data.main.Value[0]?.Label : data.main.Value?.Label;
              const subLabel = Array.isArray(data.sub.Value) ? data.sub.Value[0]?.Label : data.sub.Value?.Label;
              
              return mainLabel?.includes(item.option) && subLabel?.includes(item.suboption);
            }).length;

          return item;
        });

        [...new Set(eventData.map(data => data.name))].forEach(name => {
          const dataName = name.split(" & ");
          const fieldContainers = Array.from(document.querySelectorAll('div[class*="fieldContainer"]'));

          const mainField = fieldContainers.filter(container =>
            container.querySelector('span[id*="titleLabel"]')?.textContent.includes(dataName[0])
          )[0];

          const subField = fieldContainers.filter(container =>
            container.querySelector('span[id*="titleLabel"]')?.textContent.includes(dataName[1])
          )[0];

          mainField.addEventListener("change", function(event) {
            const selected = document.querySelector(`label[for*="${event.target.value}"]`).textContent;
            const limitSubOptions = eventData
              .filter(data => name.includes(data.name) && selected.includes(data.option) && data.count >= data.limit)
              .map(data => data.suboption);

            subField.querySelectorAll('div[class*="fieldItem"]').forEach(item => {
              item.querySelector('span.textLine').style = '';
              item.querySelector('input').disabled = false;
            });

            limitSubOptions.forEach(suboption => {
              subField.querySelectorAll('div[class*="fieldItem"]').forEach(item => {
                const label = item.querySelector('span.textLine');

                if (label.textContent.includes(suboption)) {
                  label.style = 'text-decoration: line-through';
                  item.querySelector('input').disabled = true;
                  item.querySelector('input').checked = false;
                }
              });
            });
          });

          mainField.querySelector('a.clearSelectionLabel').addEventListener("click", function(event) {
            subField.querySelectorAll('div[class*="fieldItem"]').forEach(item => {
              item.querySelector('span.textLine').style = '';
              item.querySelector('input').disabled = false;
            });
          });
        });
      }

      addWaitlist(soldOutField, soldOutNames) {
        soldOutField.querySelector('div[id*="RadioGroup"]')
          .innerHTML += `
    <div style="margin-bottom: 10px">
      <span>If your class is sold out... <button id="join-waitlist">Join the Waitlist</button></span>     
    </div>`;

        const modal = document.querySelector('.custom-modal#waitlist');

        soldOutNames.forEach(name => {
          modal.querySelector('#options').innerHTML += `
    <label style="display: block; margin-bottom: 10px">
      <input type="radio" name="sold-out" value="${name}"> ${name}
    </label>`;
        });

        document.getElementById('join-waitlist').addEventListener('click', function (event) {
          event.preventDefault();
          modal.showModal();
        });

        const recipientIds = this.emailRecipientIds;
        modal.querySelector('.modal-button#complete').addEventListener('click', function (event) {
          event.preventDefault();
          sendWaitlistEmail(modal, recipientIds, this.eventId);
        });

        modal.querySelector('.modal-button#cancel').addEventListener('click', function (event) {
          event.preventDefault();
          modal.close();
        });
      }

      sendWaitlistEmail(modal, emailRecipientIds, eventId) {
        toggleLoader(true, modal.querySelector('#inner-content'));

        const selected = modal.querySelector('input[name="sold-out"]:checked').value;
        const eventTitle = document.querySelector('.eventRegistrationInfoEvent .infoText').textContent.trim();
        const firstName = document.querySelector(`input[id*="TextBox7652926"]`).value;
        const lastName = document.querySelector(`input[id*="TextBox7652927"]`).value;
        const email = document.querySelector(`input[id*="TextBox7652925"]`).value;

        const emailBody = `<div><h4>${eventTitle}</h4><p><strong>Class:</strong> ${selected}</p><p><strong>Registrant:</strong> ${firstName} ${lastName} (<a href="mailto:${email}">${email}</a>)</p></div>`;

        const emailRecipients = emailRecipientIds.map(Id => ({ Id, Type: 'IndividualContactRecipient' }));

        const emailData = {
          Subject: 'Waitlist Request',
          Body: emailBody,
          Recipients: emailRecipients,
          EventId: eventId
        };

        fetch(`https://api.wildapricot.org/v2.2/rpc/189391/email/sendEmail`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(emailData)
        }).then(() => {
          modal.querySelector('#message').innerHTML = `<span>Successfully added to the waitlist: <span style="font-style: italic">${selected}</span></span>`;
          modal.querySelector('#options').style.display = 'none';
          modal.querySelector('.modal-button#complete').style.display = 'none';
          modal.querySelector('.modal-button#cancel').textContent = 'OK';

          toggleLoader(false, modal.querySelector('#inner-content'));
        });
      }

      becomeMember() {
        // Remove label and link to join if already a member
        if (this.isMember) {
          document.getElementsByClassName('captionOuterContainer')[0].style.display = 'none';

          Array.from(document.getElementsByClassName('fieldSubContainer'))
            .forEach(container => {
              const label = container.querySelector('span[id*="titleLabel"]');
              if (label && label.textContent.includes('Join Learn to Fly')) {
                container.style.display = 'none';
              }
            });
        }
      }

      rainInsurance() {
        // Remove rain date options if it is too late
        if (!this.isEarly) {
          const div = Array.from(document.getElementsByClassName('fieldSubContainer'))
            .find(container => {
              const label = container.querySelector('span[id*="titleLabel"]');
              return label && label.textContent.includes('Rain Insurance');
            });

          if (div) {
            div.querySelectorAll('div.fieldItem').forEach(item => {
              const span = item.querySelector('span.textLine');

              if (span && !span.textContent.includes('No')) {
                span.style.textDecoration = 'line-through';
                item.querySelector('input').disabled = true;
              }
            });
          }
        }
      }

      cancellationTerms() {
        // When user selects cancellation terms, show popup
        const modal = document.querySelector('.custom-modal#cancellation');

        document.body.addEventListener('click', function (event) {
          if (event.target && event.target.matches('input[id*="termsOfUseCheckBox"]')) {
            if (event.target.checked) modal.showModal();
          }
        });

        modal.querySelector('.modal-button#complete').addEventListener('click', function (event) {
          event.preventDefault();
          modal.close();
        });
      }
    }

    function insertElements(loaderOnly) {
      let element = document.getElementById('idRegistrationFormContainer')
        || document.getElementById('idSelectRegistrationTypeContainer')
        || document.getElementById('idIdentifyUserContainer');

      // Loader
      const loader = `
<div id="loader-container" style="display: none">
  <div class="loader"></div>
</div>
`;
      element.innerHTML += loader;

      // Styles
      document.head.innerHTML += `
<style>
  #loader-container {
    display: flex;
    justify-content: center;
    margin: 50px;
  }

  .loader {
    border: 10px solid rgba(0, 0, 0, 0.1);
    border-left-color: #40B2CF;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .custom-modal {
    max-width: 50%;
    max-height: 50%;
    border-radius: 5px;
    border-color: transparent;
    overflow: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .modal-content {
    margin: 20px;
  }

  .modal-button {
    float: right;
    margin-top: 20px;
    padding: 10px 20px;
    border: none;
    border-radius: 2px;
    font-size: 16px;
    cursor: pointer;
  }

  .modal-button#complete {
    margin-left: 10px;
    font-weight: bold;
  }

  #join-waitlist {
    margin-left: 5px;
    padding: 10px;
    border: none;
    border-radius: 2px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
`;

      if (!loaderOnly) {
        // Cancellation Terms
        element.innerHTML += `
<dialog class="custom-modal" id="cancellation">
  <div class="modal-content">
    <div class="gadgetStyleBody gadgetContentEditableArea" style="" data-editablearea="0" data-areaheight="auto">
      <p><span>
          <font color="#000000" face="verdana, arial, sans-serif"><span>
              <font><strong>
                  <font style="font-size: 18px;">Cancellation and Rain/No Show Protection</font>
                </strong><br></font>
            </span></font>
        </span></p>

      <p style="display: inline !important;">
        <font color="#000000" face="verdana, arial, sans-serif">
          <font>
            <font><strong><u>Penguin runs rain or shine</u></strong>, and we&nbsp;<span
                class="Apple-style-span">encourage</span>&nbsp;riders to try a rain course at some point during their
              track
              experience. It's a fantastic way to focus on proper technique and can serve as an excellent learning tool.
              &nbsp;In recent years we've updated our cancellation policies in order to give riders better options in
              the
              event that they need to cancel an event reservation for any reason.&nbsp; Registering early saves money
              and
              guarantees your spot (or your rental bike).</font>
          </font>
        </font>
      </p>

      <div>
        <p>
          <font color="#000000"><span><br>
              <span class="Apple-style-span">
                <font><span><strong>
                      <font face="verdana, arial, sans-serif" style="text-decoration-line: underline;"><strong>
                          <font face="verdana, arial, sans-serif" color="#000000">Tuition&nbsp;</font>
                        </strong>Rain/No Show Protection</font>
                      <font face="verdana, arial, sans-serif, WaWebKitSavedSpanIndex_7"><span
                          class="Apple-style-span">&nbsp;</span>(</font><span
                        style="background-color: rgb(255, 255, 0);">
                        <font color="#000000" face="verdana, arial, sans-serif"
                          style="font-family: verdana, arial, sans-serif;">This benefit is&nbsp;<strong>automatically
                            included</strong></font>
                      </span>
                      <font color="#000000" face="verdana, arial, sans-serif"
                        style="font-family: verdana, arial, sans-serif;"><span
                          style="background-color: rgb(255, 255, 0);"><span>&nbsp;for&nbsp;<a
                              href="/Learn-to-Fly-PLUS">LTF
                              Plus Members</a></span></span>)</font>
                    </strong></span></font>
              </span><span class="Apple-style-span">
                <font><br></font>
              </span></span>
            <font style="font-family: verdana, arial, sans-serif;">This option is available for most events for $25 and
              is
              available for all registrations 10 or more days in advance of the event.&nbsp;</font>
            <font>
              <font face="verdana, arial, sans-serif">&nbsp; For $25, riders get a 90% tuition transfer credit if they
                do
                not show up at an event for ANY reason.&nbsp; No notice is needed, and the credit will be issued within
                5
                days of the event.&nbsp; <span style="background-color: rgb(255, 255, 0);"><span>Riders should notify
                    Penguin by email no later than 48 hours after the event to claim their credit.</span></span>&nbsp;
                Register early and save!&nbsp;&nbsp;</font><br>
              <br>
              <strong><u>
                  <font face="verdana, arial, sans-serif">Bike Rental Rain</font>
                  <font face="verdana, arial, sans-serif, WaWebKitSavedSpanIndex_9">&nbsp;Protection</font>
                </u></strong>
              <font face="verdana, arial, sans-serif">&nbsp;Motorcycle Rentals have a separate Rain Insurance Policy for
                $50.&nbsp; If you are renting a bike, you need to select "Rain insurance with bike Rental" in order to
                cover
                the bike rental.&nbsp; Cancellations less than 10 days from the event give the insurance holder 90%
                credit
                on the rental fee.</font>
            </font>
          </font>
        </p>

        <p>
          <font color="#000000">
            <font style="font-family: verdana, arial, sans-serif; font-size: 24px;"><strong><u>Tuition</u> Rain/No Show
                Protection (automatic for LTF Plus members)</strong></font>
          </font>
        </p>

        <table width="99%" cellpadding="0" cellspacing="0" watable="1" class="contStyleExcSimpleTable"
          style="border-collapse: collapse; border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153);">
          <tbody>
            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153);" width="" height=""
                align="center">
                <font style="font-size: 14px;">&nbsp;<strong>
                    <font>Time before event</font>
                  </strong></font>
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                width="" height="" align="center"><strong>
                  <font>
                    <font style="font-size: 18px;">&nbsp;</font>
                    <font color="#1A7B30" style="font-size: 24px;">With</font>&nbsp;$25/day&nbsp;<font
                      style="font-size: 18px;">Rain-No Show Protection</font>
                  </font>
                </strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                width="" height="" align="center"><strong>
                  <font style="font-size: 18px;">&nbsp;<font color="#000000">Without</font>&nbsp;Rain-No Show Protection
                  </font>
                </strong></td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                width="" height="" align="">&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                width="" height="" align="">&nbsp;</td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;<strong>10 or more&nbsp;Days</strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top"><span>
                  <font>&nbsp; Full PRS Credit or Refunds&nbsp;<span style="background-color: rgb(204, 255, 153);">(5%
                      processing fee)</span> available</font>
                </span></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top"><span>
                  <font>&nbsp; Refunds or credits available (5% processing fee)</font>
                </span></td>
            </tr>



            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp;</td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;<strong>9&nbsp;Days or less</strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp; 90% Penguin Account transfer credit available</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp; <strong>No credits or refunds available</strong></td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp;&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp;</td>
            </tr>
          </tbody>
        </table><span><br></span>

        <p>
          <font color="#000000">
            <font style="font-family: verdana, arial, sans-serif;"><strong>
                <font style="font-size: 24px;"><u>Rental Bike</u> Rain/No Show Protection</font><br>
                <font style="font-size: 12px;">
                  <font style="font-size: 12px;">
                    <font style="font-size: 12px;">
                      <font color="#000000">Note:</font>
                      <font color="#ED1C24">Rental gear (leathers, boots, etc...)</font>
                      <font color="#000000">is fully refundable (minus a 5% processing fee) for all customers</font>
                    </font>
                  </font>
                </font>
              </strong></font>
          </font>
        </p>



        <table width="99%" cellpadding="0" cellspacing="0" watable="1" class="contStyleExcSimpleTable"
          style="border-collapse: collapse; border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153);">
          <tbody>
            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153);" width="" height=""
                align="center">
                <font style="font-size: 14px;">&nbsp;<strong>
                    <font>Time before event</font>
                  </strong></font>
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                width="" height="" align="center"><strong>
                  <font>
                    <font style="font-size: 18px;">&nbsp;</font>
                    <font color="#1A7B30" style="font-size: 24px;">With</font>&nbsp;$25/day&nbsp;<font
                      style="font-size: 18px;">Rain-No Show Protection</font>
                  </font>
                </strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                width="" height="" align="center"><strong>
                  <font style="font-size: 18px;">&nbsp;<font color="#000000">Without</font>&nbsp;Rain-No Show Protection
                  </font>
                </strong></td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                width="" height="" align="">&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                width="" height="" align="">&nbsp;</td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;<strong>10 or more&nbsp;Days&nbsp;</strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top"><span>
                  <font>&nbsp; <span>
                      <font>Full PRS Credit or Refunds&nbsp;<span style="background-color: rgb(204, 255, 153);">(5%
                          processing fee)</span> available&nbsp;</font>
                    </span></font>
                </span></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top"><span>
                  <font>&nbsp; Refunds or credits available (minus a 5% processing fee)</font>
                </span></td>
            </tr>



            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp;</td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;<strong>9&nbsp;Days or less</strong></td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp; 90% Penguin Account transfer credit available</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp; <strong>No credits or refunds available</strong></td>
            </tr>

            <tr>
              <td style="border-style: solid; border-width: 1px; border-color: #999999;" width="" height="" align="">
                &nbsp;
              </td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(204, 255, 153);"
                valign="top">&nbsp;&nbsp;</td>

              <td
                style="border-style: solid; border-width: 1px; border-color: rgb(153, 153, 153); background-color: rgb(255, 153, 0);"
                valign="top">&nbsp;</td>
            </tr>
          </tbody>
        </table>
        <font color="#000000">
          <font style="font-family: verdana, arial, sans-serif;"><strong>
              <font style="font-size: 12px;">
                <font style="font-size: 12px;"></font>
              </font>
            </strong></font>
        </font><span>&nbsp; &nbsp;&nbsp;</span>
      </div>

      <div>
        <ul>
          <li style="list-style: none; display: inline">
            <ul></ul>
          </li>
        </ul>
      </div>

      <div>
        <ul style="line-height: 18px;"></ul><span>
          <font color="#000000"><strong>To put in a cancellation request, please <a
                href="mailto:info@penguinracing.com">email your name &amp; requested date to:
                info@penguinracing.com</a>&nbsp;<br>
              All requests will be responded to and confirmed in 5 days or less.</strong></font>
        </span>
      </div>
    </div>
  </div>

  <button class="modal-button" id="complete">I Acknowledge and Agree</button>
</dialog>
`;

        // Join Waitlist
        element.innerHTML += `
<dialog class="custom-modal" id="waitlist">
  <div class="modal-content">
    <h4>Join the Waitlist</h4>
    <div id="inner-content">
      <p id="message"><span style="font-style: italic">Select Sold Out Class:</span></p>
      <div id="options"></div>
      <button class="modal-button" id="complete">Submit</button>
      <button class="modal-button" id="cancel">Cancel</button>
    </div>
    ${loader}
  </div>
</dialog>
`;
      }
    }

    function toggleLoader(display, hideContainer) {
      if (!hideContainer) {
        hideContainer = document.querySelector('#idGeneralFormContainer');
      }

      hideContainer.style.display = display ? 'none' : 'block';
      document.querySelector('#loader-container').style.display = display ? 'flex' : 'none';
    }

    function watchForChanges() {
      const observer = new MutationObserver(() => {
        execute();
      });

      observer.observe(document.querySelector('h3.formTitle'), { childList: true, subtree: true, attributes: true });
    }

    async function handleUserData(token, userData) {
      try {
        const fetchRegistrationData = await fetch(`https://api.wildapricot.org/v2.2/accounts/189391/eventregistrations?contactId=${userData.Id}`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const registrationData = await fetchRegistrationData.json();

        if (registrationData && registrationData.length == 0) {
          const before = document.getElementById('idInfoContainer');
          const newElement = document.createElement('div');
          newElement.innerHTML += `
            <div style="background-color: rgba(64, 178, 207, 0.1); border-left: 5px solid #40b2cf; padding: 15px 25px; margin-bottom: 30px; font-size: 16px;">
              <h4 style="margin-top: 0; margin-bottom: 5px; text-align: left;">New to Penguin?</h4>
              Review your 
              <a href="https://www.penguinracing.com/Rider-Ability" target="_blank" style="color: #40b2cf; text-decoration: underline; font-weight: bold;">Rider Ability</a> 
              and check 
              <a href="https://www.penguinracing.com/Equipment-Requirements" target="_blank" style="color: #40b2cf; text-decoration: underline; font-weight: bold;">Equipment Requirements</a> 
            </div>`;

          before.after(newElement);
        }
      } catch (error) {
        console.error('Error fetching user registration data:', error);
      }
    }

    async function fetchToken() {
      const apiKey = '2zg7tr5uj4axxvm8ayx2s8nxd14zer';
      const base64 = btoa(`APIKEY:${apiKey}`);

      try {
        const authResponse = await fetch('https://oauth.wildapricot.org/auth/token', {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${base64}`,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: 'grant_type=client_credentials&scope=auto',
        });
        const authData = await authResponse.json();
        return authData.access_token;
      } catch (error) {
        console.error('Error fetching token:', error);
        return null;
      }
    }

    async function fetchUserData() {
      try {
        const fetchUser = await fetch('/sys/api/v2/accounts/189391/contacts/me', {
          method: 'GET',
          headers: { 'clientId': 'devUser' },
          cache: 'no-store'
        });
        return await fetchUser.json();
      } catch (error) {
        console.error('Error fetching user data:', error);
        return null;
      }
    }

    async function handleGuest(id) {
      try {
        const fetchGuest = await fetch(`/sys/api/v2/accounts/189391/eventregistrations/${id}`, {
          method: 'GET',
          headers: { 'clientId': 'devUser' },
          cache: 'no-cache'
        });
        return await fetchGuest.json();
      } catch (error) {
        console.error(error);
      }
    }

    async function fetchRegistrationInfoData(token, eventId, userData) {
      try {
        const fetchRegistrationData = await fetch(`https://api.wildapricot.org/v2.2/accounts/189391/eventregistrations?eventId=${eventId}`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const registrationData = await fetchRegistrationData.json();

        for (registration of registrationData) {
          const guests = registration.GuestRegistrationsSummary?.GuestRegistrations;
          if (guests?.length > 0) {
            for (guest of guests) {
              const guestRegistration = await handleGuest(guest.Id);
              registrationData.push(guestRegistration);
            }
          }
        }

        const fetchLimits = await fetch('/resources/Admin_Registration_Management.json');
        const allLimits = await fetchLimits.json();

        const eventLimits = allLimits.data.find(eventsWithLimits => eventsWithLimits.eventId == eventId)?.data || [];

        const eventDate = document.querySelector('div[id*=InfoEndDateStartDateTimePanel').textContent.trim().split(" - ")[0];
        const diffTime = Math.abs(new Date(eventDate) - new Date());
        const isEarly = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) > 9;

        const isMember = userData?.MembershipLevel.Name !== 'Standard Penguin Account';

        registrationInfo = new RegistrationInfo(isEarly, isMember, eventId, eventLimits, registrationData);
        registrationInfo.execute();
      } catch (error) {
        console.error('Error fetching registration info data:', error);
      }

      return Promise.resolve();
    }

    async function execute() {
      const title = document.querySelector('h3.formTitle')?.textContent.trim();
      const eventId = document.querySelector('a[href*="event-"]')?.href.split('event-')[1];
      const hideContainer = document.querySelector('#idGeneralFormContainer');

      insertElements(true);
      toggleLoader(true);

      const token = await fetchToken();
      const userData = await fetchUserData();

      if (userData) {
        await handleUserData(token, userData);
      }

      if (title === 'Choose ticket type') {
        registrationType = new RegistrationType();
        registrationType.execute();

        toggleLoader(false);
      } else if (title === 'Enter registration information') {
        insertElements(false);

        fetchRegistrationInfoData(token, eventId, userData).then(() => {
          toggleLoader(false);
        });
      } else {
        toggleLoader(false);
      }

      watchForChanges();
    }

    execute();
  </script>
</body>

</html>